---
title: "Chapter 3 Exercises - Applied"
output: 
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(MASS)
library(ISLR)
```

## Question 8

**This question involves the use of simple linear regression on the `Auto` data set.**

We start off by loading the data and taking a look at its structure:
```{r Auto str}
data("Auto")
names(Auto)
str(Auto)
```

### Part 8a
**Use the lm() function to perform a simple linear regression with mpg as the response and horsepower as the predictor. Use the summary() function to print the results. Comment on the output.**

```{r lm summary}
mpg_hp_lm <- lm(mpg ~ horsepower, data = Auto)
summary(mpg_hp_lm)
```


**For example:**  

i. Is there a relationship between the predictor and the response?  
ii. How strong is the relationship between the predictor and the response?  
iii. Is the relationship between the predictor and the response positive or negative?  
iv. What is the predicted mpg associated with a horsepower of 98? What are the associated 95% confidence and prediction intervals?  

The relation between the predictor `horsepower` and response `mpg` is negative, as shown by the estimated coefficient **`r coef(mpg_hp_lm)[2]`** which is less than 0. 

Based on the output generated by the linear model, the p-value associated with the coefficient for `horsepower` is extremely low. We can conclude that there is a **significant negative** relationship between `horsepower` and `mpg`.

The strength of the relationship between `horsepower` and `mpg` is indicated by the *Pearson correlation coefficient*. For a simple linear regression model, the correlation coefficient can be found by taking the *negative* square root (since the linear coefficient is negative) of the Multiple R-squared value in the output:
```{r}
-sqrt(summary(mpg_hp_lm)$r.squared)
```

Alternatively, the correlation coefficient can be found using the `cor()` function:  
```{r}
cor(Auto$mpg, Auto$horsepower)
```

The magnitude of the correlation coefficient suggests a **moderately strong relationship** between `horsepower` and `mpg`.

We can find out the predicted values of `mpg` and their intervals using the `predict()` function.  
The following code attempts to predict `mpg` and the 95% confidence intervals for a given set of `horsepower` values:
```{r}
predict(mpg_hp_lm, newdata = data.frame(horsepower = 98), 
        interval = "confidence")
```

We change the `interval` parameter if we want to calculate the 95% *prediction* intervals:
```{r}
predict(mpg_hp_lm, newdata = data.frame(horsepower = 98), 
        interval = "prediction")
```

Based on the output, for `horsepower` of 98, the predicted `mpg` value would be about **24.47** (miles per gallon); the 95% confidence interval would be approximately **(23.97, 24.96)** and the 95% prediction interval would be approximately **(14.81, 34.12)**.  
(The confidence interval reflects the uncertainty surrounding the predicted `mpg` averaged over multiple vehicles; the prediction interval reflects the uncertainty surrounding the `mpg` predicted for a particular vehicle, which also takes into the account the irreducible error &#1013;.)

### Part 8b
**Plot the response and the predictor. Use the abline() function to display the least squares regression line.**

```{r q8 plot}
plot(mpg ~ horsepower, data = Auto, pch = 1, cex = 0.6,
     main = "Miles per gallon against Horsepower",
     xlab = "Engine Horsepower", ylab = "Miles per Gallon")
abline(mpg_hp_lm)
```

### Part 8c
**Use the plot() function to produce diagnostic plots of the least squares regression fit. Comment on any problems you see with the fit.**
```{r q8 diagnostic plot, fig.width=12, fig.height=9}
par(mfrow = c(2,2))
plot(mpg_hp_lm)
```

A brief description of the diagnostic plots shown above:  

* The top-left plot is a residual plot, which plots the residuals *e~i~ = y~i~ - &#375;~i~* against the fitted values.  
* The top-right plot is a quantile-quantile plot (QQ plot) of the residuals to check if the residuals are normally distributed.  
* The bottom-left plot is a scale-location plot that examines if residuals are spread equally along the range of predictors and can be used to check the assumption of equal variance (homoscedascity).  
* The bottom-right plot is a plot of residuals against leverage, to check for outliers with significant leverage that would heavily influence the regression model.

From the diagnostic plots, we can see the following issues:

* The plot of residuals against fitted values appear to exhibit a pattern which suggests that our linear model is not a good fit for the relationship between `horsepower` and `mpg`: the pattern in the residuals may be due to a non-linear relationship that the model does not capture.

## Question 9

This question involves the use of multiple linear regression on the `Auto` data set.

### Part 9a

**Produce a scatterplot matrix which includes all of the variables in the data set.**

```{r q9 scatterplot, fig.width=12, fig.height=9}
plot(Auto)
```

### Part 9b

**Compute the matrix of correlations between the variables using the function cor() . You will need to exclude the `name` variable, which is qualitative.**

```{r correlation matrix}
auto_noname <- Auto[, -9] # new data frame that excludes name variable (9th column)
cor(auto_noname)
```

### Part 9c
**Use the lm() function to perform a multiple linear regression with mpg as the response and all other variables except name as the predictors. Use the summary() function to print the results.**  

```{r multiple lm summary}
auto_multiple_lm <- lm(mpg ~ ., data = auto_noname)
(auto_mlm_summary <- summary(auto_multiple_lm)) # assigns and prints the summary
```

Comment on the output. For instance:

i. Is there a relationship between the predictors and the response?  
ii. Which predictors appear to have a statistically significant relationship to the response?  
iii. What does the coefficient for the year variable suggest?  

The F-statistic for the overall model is very high, suggesting that there is a relationship between the predictors and the response (rejecting the null hypothesis that all of the predictors are not related to the response)

Based on the p-values for the t-statistic, we think the following predictors may have a statistically significant relationship with the response:  

* `displacement`
* `weight`
* `year`
* `origin`

The coefficient for year is `r round(auto_mlm_summary$coefficients["year","Estimate"], 3)`, which implies that the average miles per gallon increases by this amount every year when all other predictors are held constant.

### Part 9d
**Use the plot() function to produce diagnostic plots of the linear regression fit. Comment on any problems you see with the fit. Do the residual plots suggest any unusually large outliers? Does the leverage plot identify any observations with unusually high leverage?**

```{r q9 diagnostic plot, fig.width=12, fig.height=9}
par(mfrow = c(2,2))
plot(auto_multiple_lm)
```

* The residuals-fitted plot shows a slight pattern which suggests the presence of relationships not accounted for by our model (such as non-linear predictors).  
* There are some observations with particularly large residuals (especially index 327 which is marked on all four plots).  
* Index 14 is a high-leverage observation but the residual is not considered significant enough to severely influence the regression model.

### Part 9e
**Use the \* and : symbols to fit linear regression models with interaction effects. Do any interactions appear to be statistically significant?**

For example, we may want to find out if there may be a significant interaction between `displacement` and `horsepower` (in other words, does the relationship between `displacement` and `mpg` change depending on the `horsepower` of the vehicle?) We use the `update()` and `summary()` functions to refit the model:

```{r}
summary(
    update(auto_multiple_lm, ~ . + weight:horsepower)
    )
```

The interaction term `horsepower:weight` appears to be significant based on its p-value; in addition the R-squared value has also risen by about .04, which suggests that our new model might be a slightly better fit than the model used in Part 9c.

It's also worth noting that `horsepower` itself is also now a significant predictor, whereas `displacement` is no longer significant under this model.

<!-- test combinations of one interaction term, then spread the table -->

### Part 9f
**Try a few different transformations of the variables, such as log(X), âˆšX, X^2^ . Comment on your findings.**

We can refit the model a quadratic transformation term `horsepower^2^` to observe the fit of the new model:

```{r}
summary(
    update(auto_multiple_lm, ~ . + I(horsepower^2))
    )
```

The transformed predictor appears to be significant as well, with the R-squared value increasing by about 0.3.